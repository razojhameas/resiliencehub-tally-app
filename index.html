<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResilienceHub Survey Data Aggregator</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #333;
            --secondary-color: #f4f4f4;
            --text-color: #1a1a1a;
            --light-grey: #cccccc;
            --border-radius: 4px;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: white;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius);
        }

        h1, h2 {
            text-align: center;
            color: var(--primary-color);
        }

        h1 {
            margin-bottom: 5px;
            font-size: 2em;
            border-bottom: 2px solid var(--light-grey);
            padding-bottom: 15px;
        }

        h2 {
            margin-top: 30px;
            font-size: 1.5em;
            text-transform: uppercase;
        }
        
        /* Desktop Table View */
        .desktop-table {
            display: block; 
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            table-layout: fixed;
        }

        th, td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid var(--light-grey);
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85em;
        }
        
        td:first-child, th:first-child {
            text-align: left;
            width: 40%;
            padding-left: 15px;
        }

        .tally-cell input {
            width: 80%;
            padding: 8px 4px;
            box-sizing: border-box;
            border: 1px solid var(--light-grey);
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 1em;
            transition: border-color 0.2s;
            appearance: textfield; /* Hide default number spinners on desktop browsers */
        }
        .tally-cell input::-webkit-outer-spin-button,
        .tally-cell input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .tally-cell input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            padding: 20px 0;
            margin-top: 20px;
            border-top: 1px solid var(--light-grey);
        }

        button {
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: var(--border-radius);
            transition: background-color 0.2s, transform 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .btn-export {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-export:hover {
            background-color: #555;
            transform: translateY(-1px);
        }
        
        .btn-email {
            background-color: #777;
            color: white;
        }

        .btn-email:hover {
            background-color: #999;
            transform: translateY(-1px);
        }

        .btn-reset {
            background-color: var(--light-grey);
            color: var(--text-color);
        }
        
        .btn-reset:hover {
            background-color: #aaa;
            transform: translateY(-1px);
        }

        .profile-section {
            display: flex;
            gap: 30px;
            margin-bottom: 25px;
            justify-content: center;
            padding: 15px;
            border: 1px dashed var(--light-grey);
            border-radius: var(--border-radius);
        }

        .profile-section label {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .profile-section input[type="text"], 
        .profile-section input[type="number"] {
            padding: 5px;
            border: 1px solid var(--light-grey);
            border-radius: var(--border-radius);
            font-size: 1em;
            width: 150px;
        }
        
        .profile-section input[type="text"]:focus,
        .profile-section input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        /* Mobile Card View (Hidden by default) */
        .mobile-card-view {
            display: none;
            margin-top: 10px;
        }
        
        .tally-card {
            background: #fff;
            border: 1px solid var(--light-grey);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
        }

        .tally-card h3 {
            font-size: 1em;
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .tally-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .tally-input-group label {
            font-size: 0.9em;
            width: 60%;
            text-align: left;
        }
        
        .tally-input-group input[type="number"] {
            width: 80px; /* Large, tappable size */
            height: 40px;
            font-size: 1.1em;
            text-align: center;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 0 5px;
            appearance: number-input; /* Ensure number spinners show on mobile */
        }


        /* ======================================= */
        /* MOBILE RESPONSIVENESS (Max Width 768px) */
        /* ======================================= */
        @media (max-width: 768px) {
            
            /* Hide the standard table and show the card view */
            .desktop-table {
                display: none;
            }
            .mobile-card-view {
                display: block;
            }

            body {
                padding: 10px;
            }

            .container {
                padding: 20px 10px;
            }

            h1 {
                font-size: 1.5em;
                padding-bottom: 10px;
            }
            
            h2 {
                font-size: 1.2em;
            }

            /* Profile Section Adjustments */
            .profile-section {
                flex-direction: column;
                gap: 15px;
                padding: 10px;
                align-items: stretch;
            }
            
            .profile-section div {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            .profile-section input[type="text"],
            .profile-section input[type="number"] {
                width: 100%;
            }

            /* Controls Adjustments */
            .controls {
                flex-direction: column;
                gap: 10px;
            }

            button {
                width: 100%;
                padding: 10px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ResilienceHub Survey Data Tally</h1>
    <p style="text-align: center; font-style: italic; margin-bottom: 25px;">Tally the responses for your assigned quota and use the buttons below to export the data.</p>

    <div class="profile-section">
        <div>
            <label for="member-name">Your Name:</label>
            <input type="text" id="member-name" placeholder="Enter your name" onchange="saveProfile()">
        </div>
        <div>
            <label for="quota-collected">Quota Collected:</label>
            <input type="number" id="quota-collected" min="0" placeholder="e.g., 10" onchange="saveProfile()">
        </div>
    </div>

    <div id="tally-forms-desktop" class="desktop-table">
    </div>

    <div id="tally-forms-mobile" class="mobile-card-view">
    </div>

    <div class="controls">
        <button class="btn-export btn-email" onclick="exportData('xlsx'); emailPrompt();">
            Export to Excel & Email
        </button>
        <button class="btn-export" onclick="exportData('pdf')">
            Export to PDF
        </button>
        <button class="btn-reset" onclick="resetData()">
            Reset All Data
        </button>
    </div>
    
    <p style="text-align: center; font-size: 0.85em; color: #777; margin-top: 20px;">
        note sa aking mga member: after exportnig, magddownload siya saa phone niyo. pwedeng sa gmail @razojhames8@gmail.com, pwede rin sa messenger isend PM nalang
    </p>

</div>

<script>
    const STORAGE_KEY = 'resilienceHubSurveyData';
    const EMAIL_ADDRESS = 'razojhames8@gmail.com';

    const sections = [
        {
            title: "A. Function Suitability",
            statements: [
                "1. ResilienceHub provides accurate and reliable information about disaster preparedness.",
                "2. The platform stores and organizes community disaster risk reduction data effectively.",
                "3. Resilience Hub monitors and tracks preparedness activities (e.g., weather updates, emergency kits).",
                "4. Resilience Hub notifies determined contacts of the user's status.",
                "5. Overall preparedness data and reports can be clearly viewed in the application."
            ]
        },
        {
            title: "B. Operability",
            statements: [
                "1. ResilienceHub can help the community track and manage disaster preparedness activities.",
                "2. ResilienceHub can help families monitor their own readiness (emergency plans, go-bags, etc.).",
                "3. The application is easy to operate and user-friendly.",
                "4. The application provides language settings (e.g., English/Filipino) that are helpful to the users.",
                "5. The application can be accessed easily by users via smartphone."
            ]
        },
        {
            title: "C. Acceptability",
            statements: [
                "1. The application can be installed and accessed on smartphones.",
                "2. The application can still be used in offline mode or with limited internet connection.",
                "3. Preparedness resources (guides, checklists, alerts) can be easily searched and accessed.",
                "4. Community data and information can be obtained regularly and easily.",
                "5. The application can be accessed in bilingual settings (e.g., English and Filipino)."
            ]
        },
        {
            title: "D. User Interface Aesthetics",
            statements: [
                "1. The characters in the screen can be read easily.",
                "2. The position of messages on the screen is consistent.",
                "3. The prompts for inputs are clear.",
                "4. The system always informs about the progress of the tracker.",
                "5. The color scheme of the application is pleasing to the user."
            ]
        }
    ];

    const likertScale = ["5 - Strongly Agree", "4 - Agree", "3 - Neutral", "2 - Disagree", "1 - Strongly Disagree"];

    function loadData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            return JSON.parse(storedData);
        }

        const initialData = {
            profile: { name: '', quota: 0 },
            tally: {}
        };
        sections.forEach(section => {
            initialData.tally[section.title] = {};
            section.statements.forEach((statement, sIndex) => {
                initialData.tally[section.title][`Q${sIndex + 1}`] = {
                    statement: statement,
                    counts: likertScale.map(() => 0)
                };
            });
        });
        return initialData;
    }

    function saveData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function updateTally(sectionTitle, questionIndex, scaleIndex, value) {
        const data = loadData();
        const questionKey = `Q${questionIndex + 1}`;
        const count = Math.max(0, parseInt(value) || 0);

        data.tally[sectionTitle][questionKey].counts[scaleIndex] = count;
        saveData(data);
    }

    function saveProfile() {
        const data = loadData();
        const nameInput = document.getElementById('member-name').value;
        const quotaInput = document.getElementById('quota-collected').value;

        data.profile.name = nameInput;
        data.profile.quota = Math.max(0, parseInt(quotaInput) || 0);
        saveData(data);
    }

    function renderTables() {
        const data = loadData();
        const formsDesktopDiv = document.getElementById('tally-forms-desktop');
        const formsMobileDiv = document.getElementById('tally-forms-mobile');
        formsDesktopDiv.innerHTML = '';
        formsMobileDiv.innerHTML = '';

        sections.forEach(section => {
            // --- Desktop Table HTML ---
            const desktopTableHTML = `
                <h2>${section.title}</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Statement</th>
                            ${likertScale.map(l => `<th>${l.split(' - ')[0]}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${section.statements.map((statement, sIndex) => {
                            const questionKey = `Q${sIndex + 1}`;
                            const counts = data.tally[section.title][questionKey].counts;
                            
                            return `
                                <tr>
                                    <td>${statement}</td>
                                    ${likertScale.map((_, lIndex) => `
                                        <td class="tally-cell">
                                            <input 
                                                type="number" 
                                                min="0"
                                                value="${counts[lIndex]}"
                                                oninput="updateTally('${section.title}', ${sIndex}, ${lIndex}, this.value)"
                                            >
                                        </td>
                                    `).join('')}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            formsDesktopDiv.insertAdjacentHTML('beforeend', desktopTableHTML);

            // --- Mobile Card HTML ---
            const mobileCardHTML = `<h2>${section.title}</h2>` + 
                section.statements.map((statement, sIndex) => {
                    const questionKey = `Q${sIndex + 1}`;
                    const counts = data.tally[section.title][questionKey].counts;

                    return `
                        <div class="tally-card">
                            <h3>${statement}</h3>
                            ${likertScale.map((label, lIndex) => `
                                <div class="tally-input-group">
                                    <label>${label}</label>
                                    <input 
                                        type="number" 
                                        min="0"
                                        value="${counts[lIndex]}"
                                        oninput="updateTally('${section.title}', ${sIndex}, ${lIndex}, this.value)"
                                    >
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).join('');
            formsMobileDiv.insertAdjacentHTML('beforeend', mobileCardHTML);
        });

        document.getElementById('member-name').value = data.profile.name;
        document.getElementById('quota-collected').value = data.profile.quota;
    }

    function emailPrompt() {
        alert(`
        Your Excel file has been downloaded!
        
        NEXT STEP:
        1. Open your email.
        2. Create a new message to: ${EMAIL_ADDRESS}
        3. Attach the downloaded Excel file.
        4. Send the email.
        `);
    }

    function exportData(format) {
        const data = loadData();
        const profile = data.profile;
        const wsData = [];

        wsData.push(["Survey Data Tally for ResilienceHub"]);
        wsData.push(["Data Collector:", profile.name]);
        wsData.push(["Quota Collected:", profile.quota]);
        wsData.push([]);
        wsData.push([]);

        const headerRow = ["Section", "Statement"];
        likertScale.forEach(scale => headerRow.push(scale));
        headerRow.push("Total Count");
        wsData.push(headerRow);

        sections.forEach(section => {
            Object.keys(data.tally[section.title]).forEach((qKey, qIndex) => {
                const qData = data.tally[section.title][qKey];
                const row = [
                    qIndex === 0 ? section.title : "",
                    qData.statement
                ];
                
                let total = 0;
                qData.counts.forEach(count => {
                    row.push(count);
                    total += count;
                });
                row.push(total);

                wsData.push(row);
            });
            wsData.push([]);
        });


        const fileName = `ResilienceHub_Data_Tally_${profile.name.replace(/\s/g, '_') || 'Member'}_${new Date().toISOString().slice(0, 10)}.`;

        if (format === 'xlsx') {
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Survey Tally");
            XLSX.writeFile(wb, fileName + 'xlsx');
        } else if (format === 'pdf') {
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Survey Data Report</title>');
            printWindow.document.write('<style>body{font-family:Arial,sans-serif;font-size:10pt;} table{width:100%;border-collapse:collapse;margin-bottom:20px;} th,td{border:1px solid #333;padding:8px;text-align:left;} th{background-color:#ccc;} .profile-info{margin-bottom:20px;} @media (max-width: 768px) { th, td { font-size: 8pt; padding: 4px; } }</style>');
            printWindow.document.write('</head><body>');
            
            printWindow.document.write(`<h1>ResilienceHub Survey Data Report</h1>`);
            printWindow.document.write(`<div class="profile-info">
                <p><strong>Data Collector:</strong> ${profile.name}</p>
                <p><strong>Quota Collected:</strong> ${profile.quota}</p>
                <p><strong>Date Exported:</strong> ${new Date().toLocaleDateString()}</p>
            </div>`);

            let pdfTableHTML = '<table><thead><tr>';
            wsData[4].forEach(header => {
                pdfTableHTML += `<th>${header}</th>`;
            });
            pdfTableHTML += '</tr></thead><tbody>';

            for(let i = 5; i < wsData.length; i++) {
                pdfTableHTML += '<tr>';
                wsData[i].forEach(cell => {
                    pdfTableHTML += `<td>${cell}</td>`;
                });
                pdfTableHTML += '</tr>';
            }
            pdfTableHTML += '</tbody></table>';

            printWindow.document.write(pdfTableHTML);
            
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
    }

    function resetData() {
        if (confirm("Are you sure you want to reset ALL collected data? This action cannot be undone and will clear your tallies.")) {
            localStorage.removeItem(STORAGE_KEY);
            renderTables();
        }
    }

    window.onload = renderTables;

</script>

</body>

</html>
